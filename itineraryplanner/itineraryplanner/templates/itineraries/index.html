{% load staticfiles i18n %}
<!DOCTYPE html>
<html lang="en">

<head>
    <!-- google api key AIzaSyB62WXl60F8rx74hDmKjj_sBJRwu5Wgnlo -->
    <title>Auto-complete Map</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="{% static 'css/bootstrap/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <link href="{% static 'css/searchbox.css' %}" rel="stylesheet">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
        crossorigin="anonymous">
</head>

<body>
    <div class="modal fade plannerSuccessModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Good News!</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>The planner found a solution for your query.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
            </div>
        </div>
    </div>
    <div class="modal fade plannerFailureModal">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Sorry!</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>The planner found a plan but is not the most
                        appropriate for your needs. Try stretching the time between places.
                    Or increasing the running time for the planner.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
                </div>
            </div>
        </div>
    <div id="loadingDiv">
        <img src="{% static 'images/spinner.svg' %}" onerror="{% static 'images/spinner.gif' %}" alt="loading icon"/>
    </div>
    <div class="container-fluid wrapper">
        <button id="showSolution">Solution</button>
        <div id="solutionSteps">
        </div>
        <div class="row leftSidebar">
            <div id="places" class="col-lg-4 p-0">
                <input id="pac-input" class="controls noEnterSubmit" type="text" placeholder="Search Box">
                <form id="placesSelectedForm" method="POST" action="{% url 'itineraries:itineraryPicker' %}">
                    {% csrf_token %} {% comment %}<input type="hidden" name="" value="" />{% endcomment %}
                    <input id="id_placesToVisit" type="hidden" name="placesToVisit" />
                    <input id="id_distanceMx" type="hidden" name="distanceMx" />
                    <div class="row">
                        <div class="col-6">
                            <button id="submitPlaceSelection" class="btn-block" type="submit">Submit</button>
                        </div>
                        <div class="col-6">
                            <button id="clearPlaces" class="btn-block" type="button">Remove All</button>
                        </div>                        
                    </div>
                    
                    <div class="row awakeTimes">
                        <div class="col-6">
                            <label for="wakeUpTime">Wake Up Time</label>
                            <input class="wakeUpTime inputMask" name="wakeUpTime" type="text" size="6" value="08:00" required/>
                        </div>
                        <div class="col-6">
                            <label for="sleepTime">Go To Bed</label>
                            <input class="sleepTime inputMask" name="sleepTime" type="text" size="6" value="21:00" requried/>
                        </div>                        
                    </div>
                    <div class="transpMethodsDiv text-justify row small">
                        <div class="runForDiv col-6">
                            <label for="runFor">RunCodeFor</label>
                            <input type="number" max=100 min="2" name="runFor" class="runForInput" value="2" size="4" required placeholder="seconds">
                        </div>
                        <div class="transportationMethod col-6 text-center">
                            <label for="driving">Car</label>
                            <input class="drivingCbx" type="checkbox" name="driving" value="driving">
                            <label for="walking">Walk</label>
                            <input class="walkingCbx" type="checkbox" name="walking" value="walking" checked>
                            <label for="bicycling">Bike</label>
                            <input class="bicyclingCbx" type="checkbox" name="bicycling" value="bicycling">
                            <label for="transit">Transit</label>
                            <input class="transitCbx" type="checkbox" name="transit" value="transit">
                        </div>
                    </div>
                    <div id="searchedPlaces">
                    </div>
                </form>
            </div>
            {% comment %} Everything map related goes here {% endcomment %}
            <div id="map" class="col-lg-8">
            </div>
            <div style="display: none">
                <div id="info-content">
                    <table>
                        <tr id="iw-url-row" class="iw_table_row">
                            <td id="iw-icon" class="iw_table_icon"></td>
                            <td id="iw-url"></td>
                        </tr>
                        <tr id="iw-address-row" class="iw_table_row">
                            <td class="iw_attribute_name">Address:</td>
                            <td id="iw-address"></td>
                        </tr>
                        <tr id="iw-phone-row" class="iw_table_row">
                            <td class="iw_attribute_name">Telephone:</td>
                            <td id="iw-phone"></td>
                        </tr>
                        <tr id="iw-rating-row" class="iw_table_row">
                            <td class="iw_attribute_name">Rating:</td>
                            <td id="iw-rating"></td>
                        </tr>
                        <tr id="iw-website-row" class="iw_table_row">
                            <td class="iw_attribute_name">Website:</td>
                            <td id="iw-website"></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <!-- end of row-->
    </div>
    <!-- end of wrapper-->
    <script type="text/javascript" src="{% static 'js/jquery-3.2.1.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/js.cookie.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/moment.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bootstrap/tether/tether.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/bootstrap/bootstrap.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery.inputmask.bundle.js' %}"></script>  
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB62WXl60F8rx74hDmKjj_sBJRwu5Wgnlo&libraries=places"></script>
    {% comment %}
    <script type="text/javascript" src="{% static 'js/itineraryPicker.js' %}"></script>{% endcomment %}
    <script>
        var $loading = $('#loadingDiv').hide();
        $(document)
            .ajaxStart(function () {
                $loading.show();
            })
            .ajaxStop(function () {
                $loading.hide();
            }).ready(function(){
                $('.inputMask').inputmask("hh:mm"); //specifying options
              });
        // Input Mask plugin info
        var successURL = "{{success_url}}";
        var distanceMatrix = [];
        var mapInitialLocation = {
            lat: 51.50770709999999,
            lng: -0.12877930000001925
        };
        var map, placesService, infoWindow;
        var markers = [];
        var placesSelected = [];
        var placesWithNames = {};
        var idOfPlacesSelected = [];
        // this list holds the complete google response after search (place object)
        var googleSearchedPlaces = [];
        var hostnameRegexp = new RegExp('^https?://.+?/');
        // global list for directionRenderer
        directionsRendererList = [];
        var showButtonClicked = false;
        //var service = new google.maps.DistanceMatrixService;
        // debugger;
        // var csrftoken = Cookies.get('csrftoken');
        // initializing Map
        // dictionary to transalte values for transportation methods
        transporation_equivalences =  {
            'walk':'WALKING',
            'bike':'BICYCLING',
            'car':'DRIVING',
            'tube':'TRANSIT'
        }
        map = new google.maps.Map(document.getElementById("map"), {
            center: mapInitialLocation,
            zoom: 15,
            mapTypeId: "roadmap"
        });
        // init container for the place of interest information
        infoWindow = new google.maps.InfoWindow({
            content: document.getElementById('info-content'),
            // TODO: Check why originally is misplaced.
            pixelOffset: new google.maps.Size(-28, 0)
        });
        // init placesService instance 
        placesService = new google.maps.places.PlacesService(map);
        var defaultBounds = new google.maps.LatLngBounds(
            new google.maps.LatLng(51.242047, -0.568342), // southWest (Guildford)
            new google.maps.LatLng(51.712468, 0.238466) // northEast (Chipping Ongard)
        );
        // Create the search box and link it to the UI element.
        var input = document.getElementById("pac-input");
        var searchBox = new google.maps.places.SearchBox(input, { bounds: defaultBounds });
        map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);
        // Bias the SearchBox results towards current map's viewport.
        map.addListener("bounds_changed", function () {
            searchBox.setBounds(map.getBounds());
        });
        // Listen for the event fired when the user selects a prediction and retrieve
        // more details for that place.
        // FILTERING!!! https://stackoverflow.com/questions/35873804/using-google-places-searchbox-to-retrieve-only-address-results
        searchBox.addListener("places_changed", function () {
            // we just want one place or at least the first one.
            var places = searchBox.getPlaces();

            // TODO: HACK to only get the first one. IS NOT PERFECT I KNOW.
            var place = places[0];
            if (places.length === 0) {
                return;
            }
            // For each place, get the icon, name and location.
            var bounds = new google.maps.LatLngBounds();
            //places.forEach(function (place) {
            if (!place.geometry) {
                console.log("Returned place contains no geometry");
                return;
            }
            // debugger;
            if (jQuery.inArray(place.place_id, idOfPlacesSelected) === -1) {
                googleSearchedPlaces.push("place_id:" + place.place_id);
                placesSelected.push(place);
                idOfPlacesSelected.push(place.place_id);
                placesWithNames[place.place_id]=place.name;
                populateMarkers(place);
                if (place.geometry.viewport) {
                    // Only geocodes have viewport.
                    bounds.union(place.geometry.viewport);
                } else {
                    bounds.extend(place.geometry.location);
                }
                map.fitBounds(bounds);
            }
            else {
                alert("It appears you already selected that place.\nTry a new one");
                $('#pac-input').val(" ");
                $('#pac-input').focus();
            }
            //});
            $('#pac-input').val("");
        });

        // We no longer use this function because we delegate it to the Back End.
        /*
        function distanceMatrixCall() {
            var computedDistances = [];
            var gs = new google.maps.DistanceMatrixService;
            gs.getDistanceMatrix({
                //origins:googleSearchedPlaces,
                //destinations: googleSearchedPlaces,
                // Replace this lines if we want to go back to normal behaviour
                origins: placesSelected,
                destinations: placesSelected,
                travelMode: 'WALKING',
                unitSystem: google.maps.UnitSystem.METRIC,
                avoidHighways: false,
                avoidTolls: false
            }, function (response, status) {
                if (status !== 'OK') {
                    console.log("Error was: " + status);
                } else {
                    console.log(response);
                    computedDistances.push(response);
                }
                var toSubmitList = []
                markers.map(function (marker) {
                    return toSubmitList.push(make_json_marker(marker));
                });
                // Section in which we format the data with the distances
                //var rawDistanceMatrix = [];
                //for (var i = 0; i < computedDistances[0].originAddresses.length; i++) {
                //    var results = computedDistances[0].rows[i].elements;
                //    for (var j = 0; j < results.length; j++) {
                //        if (computedDistances[0].originAddresses[i] != computedDistances[0].destinationAddresses[j]) {
                //            console.log(computedDistances[0].originAddresses[i], " to: ", computedDistances[0].destinationAddresses[j]);
                //            console.log("in...", results[j].duration.text);
                //            var distanceMatrixObject = {};
                //            distanceMatrixObject['from'] = computedDistances[0].originAddresses[i];
                //            distanceMatrixObject['to'] = computedDistances[0].destinationAddresses[j];
                //            distanceMatrixObject['durationText'] = results[j].duration.text;
                //            distanceMatrixObject['durationSeconds'] = results[j].duration.value;
                //            rawDistanceMatrix.push(distanceMatrixObject);
                //        }
                //    }
                //}
                // 
                //var toSubmitFormattedJson = JSON.stringify(rawDistanceMatrix);
                // End of the section. TODO: Refactor it.
                var toSubmitJsonList = JSON.stringify(toSubmitList);
                //var toSubmitJsonMatrix = JSON.stringify(computedDistances);
                //console.log(toSubmitJsonMatrix);
                $.ajax({
                    type: "POST",
                    url: successURL,
                    data: { placesToVisit: toSubmitJsonList},
                    success: function (json) {
                        // What we receive from success on server side.
                        console.log("success!");
                        console.log(json.responseJSON);
                        $("#submitPlaceSelection").attr("disabled", false);
                    },
                    error: function (json) {
                        // in case of error we get this from server
                        $("#submitPlaceSelection").attr("disabled", false);
                        console.log(json.responseJSON);
                    },
                });
            });
        };
        */
        function breakOutTimes(time){
            var timeArray = time.split(":");
            var timeHours = timeArray[0];
            var timeMinutes = timeArray[1];
            return timeHours+timeMinutes
        }
        
        // Listener for the submit inside the sidebar list with selectedPlaces.
        $('#placesSelectedForm').on('submit', function (e) {
            e.preventDefault();
            // Section of the code to retrieve Properties.
            var properties = {}
            var $transportationMethods = {
                'driving':false,
                'walking': false,
                'bicycling': false,
                'transit': false
            }
            var sleepAt = breakOutTimes($('.sleepTime').val());
            var wakeUpAt = breakOutTimes($('.wakeUpTime').val());
            var runFor = $('.runForInput').val();
            if (runFor < 0 && runFor > 100){
                runFor = 5;
            }
            properties['sleepTime'] = sleepAt;
            properties['wakeUpTime'] = wakeUpAt;
            properties['runFor'] = runFor;
            // Section of the code to retrieve transportation methods
            
            $('.transportationMethod [type="checkbox"]').each(function(){
                var name = $(this).attr('name');
                var checked = $(this).prop('checked');
                $transportationMethods[name]=checked;
            });

            console.log($transportationMethods);
            properties['methods'] = $transportationMethods;
            //properties['methods'] = {'driving': false, 'walking': true }            
            //$myForm = JSON.stringify($(this).serializeArray());
            var toSubmitProperties = JSON.stringify(properties);

            var awakeTimes = $()
            // Preparing Preferences Dict 
            var preferenceDict = {};
            $( "#searchedPlaces ul" ).children().each(function(){ 
                var key = $(this).data()['place_id'];
                preferenceDict[key] = {};
                preferenceDict[key]['priority']=$(this).find('.priorityInput').val();
                preferenceDict[key]['visitFor']=$(this).find('.visitForInput').val();
                preferenceDict[key]['startAt']=$(this).find('.startAtInput:checked').val()||false;
                preferenceDict[key]['endAt']=$(this).find('.endAtInput:checked').val()||false;
            });
            var toSubmitPreferences = JSON.stringify(preferenceDict);         
            $("#submitPlaceSelection").attr("disabled", true);
            if (markers.length <= 1) {
                alert("You need to add more than one location.");
                $("#submitPlaceSelection").attr("disabled", false);
                return;
            }
            // pending to disable button to stop user submitting turbo madness
            //console.log($(this));
            // DistanceMatrixCall goes to external Google Service
            // Therefore we wrap it up in a different function with
            // its callback.
            var toSubmitList = []
            markers.map(function (marker) {
                return toSubmitList.push(make_json_marker(marker));
            });
            var toSubmitJsonList = JSON.stringify(toSubmitList);
            /***************************
            Delete old solution to make room for a new one
            *******************************/
            clearOldSolution();
            var csrftoken = Cookies.get('csrftoken');
            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            };
            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });
            $.ajax({
                type: "POST",
                url: successURL,
                data: { 
                    placesToVisit: toSubmitJsonList, 
                    preferences: toSubmitPreferences,
                    properties: toSubmitProperties    
                },
                success: function (json) {
                    // What we receive from success on server side.
                    let solved = JSON.parse(json['solved']);
                    if(solved){
                        $('.plannerSuccessModal').modal()
                    }
                    else{
                        $('.plannerFailureModal').modal()
                    }
                    drawRoute(json);
                    displaySolutions(JSON.parse(json['final_plan']))     
                    $("#submitPlaceSelection").attr("disabled", false);
                },
                error: function (json) {
                    // in case of error we get this from server
                    $("#submitPlaceSelection").attr("disabled", false);
                    alert("An error has occured. Please check the log.");
                    console.log(json.responseJSON);
                },
            });
        });

        function clearOldSolution(){
            showButtonClicked = false;
            $('#showSolution').text('Hide Plan');
            $('#showSolution').hide();
            $('#solutionSteps').empty().hide();
        }
        $('#showSolution').on("click", function(){
            if (showButtonClicked){
                // haven't clicked so let's toggle text:
                $(this).text('Show Plan');
                $('#solutionSteps').hide();
            }
            else{
                $(this).text('Hide Plan');
                $('#solutionSteps').show();
            }
            showButtonClicked = !showButtonClicked
        })

        function displaySolutions(planDict){
            $('#showSolution').show();
            showButtonClicked=true;

            $('#solutionSteps').show();
            /*
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">List group item heading</h5>
                    <small>3 days ago</small>
                </div>
                <p class="mb-1">Donec id elit non mi porta gravida at eget metus. Maecenas sed diam eget risus varius blandit.</p>
                <small>Donec id elit non mi porta.</small>
            */
            var $solutionWrapper = $('#solutionSteps');
            var $solutionList = $('<div class="list-group flex-column align-items-stretch">');
            Object.keys(planDict).forEach(function(currentKey) {
                var markerToTriggerOnClick;
                console.log(currentKey, planDict[currentKey]);
                var solMethod =planDict[currentKey]['method'];
                var $stepWrapper = $('<div class="list-group-item">');
                /*********VISIT ****************************/
                if (solMethod==='visit'){
                    var $visitFor = planDict[currentKey]['visitFor'];
                    var $place = placesWithNames[planDict[currentKey]['visitPlaceId']];
                    var $stepDiv = $('<div class="">');
                    $stepDiv.append(
                        $('<p data-index='+currentKey+'>').append($('<h5>Visit</h5>'))
                    ).append(
                        $('<small>'+$place+'</small>')
                    ).append(
                        $('<p>For: '+$visitFor+' minutes.</p>')
                    );
                    var $indexDiv = $('<div class="">').append(
                        $('<div class="p-3">Step:'+planDict[currentKey]['index']+'</div>')
                    );
                    $stepWrapper.append($indexDiv);
                    $stepWrapper.append($stepDiv);
                    $solutionList.append($stepWrapper);
                    /******* Add Click event to Marker ************/
                    markers.forEach(function(marker){
                        if (planDict[currentKey]['visitPlaceId']===marker.placeResult.place_id){
                            markerToTriggerOnClick = marker;
                        }
                    });
                    $stepWrapper.on("click", function(){
                        google.maps.event.trigger(markerToTriggerOnClick, 'click');
                    });
                }
                /*********MOVE ****************************/
                else{
                    var $from = placesWithNames[planDict[currentKey]['fromPlaceId']];
                    var $to = placesWithNames[planDict[currentKey]['toPlaceId']];
                    var $duration = planDict[currentKey]['duration'];
                    var $stepDiv = $('<div class="">');
                    $stepDiv.append(
                        $('<p data-index='+currentKey+'>').append($('<h5>Move</h5>'))
                    ).append(
                        $('<small>FROM: '+$from+'</small></br>')
                    ).append(
                        $('<small>TO: '+$to+'</small>')
                    ).append(
                        $('<p>Takes: '+$duration+' minutes. Method: '+solMethod+'</p>')
                    );
                    var $indexDiv = $('<div class="">').append(
                        $('<div class="p-3">Step:'+planDict[currentKey]['index']+'</div>')
                    );
                    $stepWrapper.append($indexDiv);
                    $stepWrapper.append($stepDiv);
                    $solutionList.append($stepWrapper);
                    /******* Add Click event to Marker ************/
                    markers.forEach(function(marker){
                        if (planDict[currentKey]['toPlaceId']===marker.placeResult.place_id){
                            markerToTriggerOnClick = marker;
                        }
                    });
                    $stepWrapper.on("click", function(){
                        google.maps.event.trigger(markerToTriggerOnClick, 'click');
                    });
                }

            });
            $solutionWrapper.append($solutionList);

            //$('#showSolution').toggle();
            //$('#showSolution').text('Show Solution');
            //$('#solutionSteps').toggle();

        }
        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }
        function renderDirections(result) {

            var polylineOptionsActual = new google.maps.Polyline({
                strokeColor: getRandomColor(),
                strokeOpacity: 0.6,
                strokeWeight: 4,
            });
            //if (window.directionsRenderer != null) {
            //    directionsRenderer.setMap(null);
            //    directionsRenderer = null;
            //}
            directionsRenderer.push(
                new google.maps.DirectionsRenderer(
                    { 
                        map: map,
                        suppressMarkers: true, 
                        polylineOptions: polylineOptionsActual 
                    }
                ).setDirections(result)
            )

            //window.directionsRenderer.setMap(map);
            //window.directionsRenderer.setDirections(result);
        }


        function drawRoute(json) {
            //debugger;
            window.directionsService = new google.maps.DirectionsService;
            planDict = JSON.parse(json['final_plan']);  
            directions = []; 
            // clear old renderers.
            directionsRendererList.forEach(function(directionRenderer){
                directionRenderer.setMap(null);
                directionRenderer = null;
            });
            directionsRendererList=[];
            Object.keys(planDict).forEach(function(key){
                if (planDict[key]['method'] !== 'visit'){
                    var fromPlaceId = planDict[key]['fromPlaceId'];
                    var toPlaceId = planDict[key]['toPlaceId'];
                    var method = planDict[key]['method'];
                    var googleMethod = transporation_equivalences[method]
                    var fromLocation = null;
                    var toLocation = null;

                    placesSelected.forEach(function(element){
                        if (element.place_id === fromPlaceId){
                            fromLocation = element.geometry.location;
                        }
                        if (element.place_id === toPlaceId){
                            toLocation = element.geometry.location;
                        }
                    });
                    window.directionsService.route({
                        origin: fromLocation,
                        destination: toLocation,
                        travelMode: google.maps.TravelMode[googleMethod]
                        }, function(response, status) {
                            if (status === 'OK') {
                                //window.directionsDisplay.setDirections(response);
                                directions.push(response);  
                                // create a polyline with random color
                                var polylineOptionsActual = new google.maps.Polyline({
                                    strokeColor: getRandomColor(),
                                    strokeOpacity: 0.6,
                                    strokeWeight: 4,
                                });
                                // for each response create a new renderer object.
                                if (googleMethod = 'BICICLYNG'){
                                    var directionRenderer = new google.maps.DirectionsRenderer(
                                        { 
                                            map: map,
                                            suppressMarkers: true, 
                                            polylineOptions: polylineOptionsActual,
                                            suppressBicyclingLayer: true
                                        }
                                    )
                                }
                                else{
                                    var directionRenderer = new google.maps.DirectionsRenderer(
                                        { 
                                            map: map,
                                            suppressMarkers: true, 
                                            polylineOptions: polylineOptionsActual,
                                        }
                                    )
                                }
                                directionRenderer.setDirections(response)
                                directionsRendererList.push(directionRenderer);
                                //renderDirections(response);
                            } else {
                                window.alert('Directions request failed due to ' + status);
                            }
                    });
                }
                //window.directionsDisplay.setDirections(directions);
            });
            
        }
  

        // Listener for Clear button in case user wants to delete every marker from map
        $('#clearPlaces').on('click', function (e) { clearOldMarkers(); });

        function make_json_marker(marker) {
            let openingTimes = getPlaceOpeningTimes(marker.placeResult);
            let opens = openingTimes.opens;
            let closes = openingTimes.closes;
            let $marker_obj = {
                "place_id": marker.placeResult.place_id,
                "is_hotel": false,
                "name": marker.placeResult.name,
                "lat": marker.position.lat(),
                "lng": marker.position.lng(),
                "opens": opens,
                "closes": closes
            }
            return $marker_obj
        }

        function addPlaceToList(googlePlace) {
            placesSelected.push(googlePlace);
            // addSelectedPlaceToSidebar(googlePlace);
        }
        function getPlaceOpeningTimes(placeResult) {
            let has_opening_hours = placeResult.hasOwnProperty('opening_hours');
            let today = moment().format('d');
            let opens = null;
            let closes = null;
            if (has_opening_hours) {
                if (placeResult.opening_hours.hasOwnProperty('periods')) {
                    if (placeResult.opening_hours.periods.length === 1) {
                        // it opens 24 hours. Therefore not closing.
                        if (!placeResult.opening_hours.periods[0].hasOwnProperty('close')) {
                            opens = '0000'
                        }
                    }
                    else if (placeResult.opening_hours.periods.length > today) {
                        opens = placeResult.opening_hours.periods[today].open.time;
                        closes = placeResult.opening_hours.periods[today].close.time;
                    }
                    // This else only occurs if one of the days is a Festivity or similar.
                    else{
                        opens = placeResult.opening_hours.periods[0].open.time;
                        closes = placeResult.opening_hours.periods[0].close.time;
                    }
                }
            }
            return {
                'opens': opens,
                'closes': closes
            }
        }
        function addSelectedPlaceToSidebar(googlePlaceMarker) {
            // Function to add places to the sidebar.
            var $searchedPlaces = $('#searchedPlaces');
            // only create the UL if it doesn't exist already.            
            if ($('#searchedPlaces ul').length === 0) {
                var $ul = $('<ul>').addClass('list-group');
                // beChecked used to default Initial Place (hotel)
                var beChecked = true;
            }
            else {
                var $ul = $('#searchedPlaces ul');
                var beChecked = false;
            }
            var $name = googlePlaceMarker.title;
            var $place_id = googlePlaceMarker.placeResult.place_id;
            if (googlePlaceMarker.placeResult.photos) {
                var picture = googlePlaceMarker.placeResult.photos[0].getUrl({ 'maxWidth': 120, 'maxHeight': 120 })
            }
            else {
                // TODO: Change placeholder to a local image to avoid API Calls.
                var picture = 'https://dummyimage.com/80x80/000/ffffff&text=No+Picture';
            }

            //var $imgDiv = $('<div>').addClass('align-self-center p-2');
            //var $img = $('<img>').prop('src', picture);
            //$imgDiv.append($img);

            var $liWrapper = $('<li data-place_id='+$place_id+'>').addClass('placeItem container');
            var $placeRow = $('<div>').addClass('row');
            var $titleDiv = $('<div>').addClass('col-10');
            var $titleElement = $('<p>').text($name);
            $titleDiv.append($titleElement);
            var $removePlaceButton = $('<div class="col-2 removePlaceBtn"><a class="btn" href="#" data-place_id="'+$place_id+'"><i class="fa fa-window-close" aria-hidden="true"></i></a></div>');
            var $priorityDiv = $('<div>').addClass('col-8');
            var $priorityLabel = $('<label for="priority">Priority</label>');
            $priorityDiv.append($priorityLabel).append(
                $('<select>')
                    .attr('name', 'priority')
                    .attr('id', 'priority')
                    .addClass('priorityInput mx-2')
                    .append(
                    $('<option>', {
                        value: 0,
                        text: "Visit if Possible"
                    }))
                    .append(
                    $('<option>', {
                        value: 1,
                        text: "Like to Visit"
                    }))
                    .append(
                    $('<option>', {
                        value: 2,
                        text: "Should Visit"
                    })
                    )
                    .append(
                    $('<option>', {
                        value: 3,
                        text: "Must Visit"
                    })
                    ).prop('required', true)
            );
            if (beChecked){
                var $inputForStartAt = $('<input>', { type: 'radio', name: 'startAt', checked: beChecked, value: $place_id});
                var $inputForEndAt = $('<input>', { type: 'radio', name: 'endAt',checked: beChecked , value: $place_id});            
            }
            else{
                var $inputForStartAt = $('<input>', { type: 'radio', name: 'startAt', value: $place_id});
                var $inputForEndAt = $('<input>', { type: 'radio', name: 'endAt', value: $place_id });
            }
            $inputForStartAt.addClass('startAtInput');
            $inputForEndAt.addClass('endAtInput');
            var $startAtDiv = $('<div class="col-4 startAtDiv">').append(
                $('<label for="startAt">Start-at:</label>')
            ).append(
                $inputForStartAt
            );
            var $endAtDiv = $('<div class="col-4 endAtDiv">').append(
                $('<label for="endAt">End-at:</label>')
            ).append(
                $inputForEndAt
            );
            var $spendDiv = $('<div class="col-8">').append(
                $('<label for="visit-for">Spend</label>')
            ).append(
                $('<input>', { type: 'number', name: 'visit-for', value: '30' })
                .addClass('visitForInput rounded mx-1')
                .prop('required', true)
                .prop('width', 5)
            );
            $liWrapper.append($placeRow);
            $placeRow.append(
                $placeRow
            ).append(
                $titleDiv
            ).append(
                $removePlaceButton
            ).append(
                $priorityDiv
            ).append(
                $startAtDiv
            ).append(
                $spendDiv    
            ).append(
                $endAtDiv
            );
            $liWrapper.on("click", function () {
                google.maps.event.trigger(googlePlaceMarker, 'click');
            });
            $ul.append($liWrapper);
            $searchedPlaces.append($ul);
            
            //$removePlaceButton.on('click', clearThisMarker($(this).children().data()));
            $removePlaceButton.on('click', function(){
                var placeId = $(this).children().data()['place_id'];
                console.log(placeId);    
                clearThisMarker(placeId);
            });
            /*
            var $optionsDiv = $('<div>').addClass('d-flex flex-column');
            var $placeTitleDiv = $('<h5>').text($name).removeClass();
            var $flexRow = $('<div>').addClass('container');
            var $priorityLikeInputs = $('<div>').addClass('d-flex align-items-baseline');
            var $secondOptionsDiv = $('<div>').addClass('d-flex');
            var $startEndInputsDiv = $('<div>').addClass('p-1');
            var $labelForStartAt = $('<label for="startAt">Start-at:</label>');
            var $labelForEndAt = $('<label for="endAt">End-At</label>');
            if (beChecked){
                var $inputForStartAt = $('<input>', { type: 'radio', name: 'startAt', checked: beChecked});
                var $inputForEndAt = $('<input>', { type: 'radio', name: 'endAt',checked: beChecked });            
            }
            else{
                var $inputForStartAt = $('<input>', { type: 'radio', name: 'startAt'});
                var $inputForEndAt = $('<input>', { type: 'radio', name: 'endAt' });
            }
            $optionsDiv.append($placeTitleDiv);
            $optionsDiv.append('<input name="place_id" type="hidden" value="'+$place_id+'">');
            var $prioritySelectorInput = $('<select>')
                .attr('name', 'priority')
                .attr('id', 'priority')
                .addClass('mx-2')
                .append(
                $('<option>', {
                    value: 0,
                    text: "Visit if Possible"
                }))
                .append(
                $('<option>', {
                    value: 1,
                    text: "Like to Visit"
                }))
                .append(
                $('<option>', {
                    value: 2,
                    text: "Should Visit!"
                })
                )
                .append(
                $('<option>', {
                    value: 3,
                    text: "Must Visit!!!"
                })
                ).prop('required', true);
            $optionsDiv.append($prioritySelectorInput);
            $secondOptionsDiv.append($startEndInputsDiv)
                .append($labelForStartAt)
                .append($inputForStartAt)
                .append($labelForEndAt)
                .append($inputForEndAt);
            var $opensClosesDiv = $('<div>').addClass('p-1');
            var $opensSpan = $('<span><i class="fa fa-clock-o mr-1"></i>Opens: 11:00</span>');
            var $closesSpan = $('<span><i class="fa fa-clock-o mr-1"></i>Closes: 22:00</span>');
            var $priorityLabel = $('<label class="d-inline-flex" for="priority">Priority</label>');
            $secondOptionsDiv.append($opensClosesDiv)
                .append($opensSpan)
                .append($closesSpan);
            var $prioritySelectorInput = $('<select>')
                .attr('name', 'priority')
                .attr('id', 'priority')
                .addClass('mx-2')
                .append(
                $('<option>', {
                    value: 0,
                    text: "Visit if Possible"
                }))
                .append(
                $('<option>', {
                    value: 1,
                    text: "Like to Visit"
                }))
                .append(
                $('<option>', {
                    value: 2,
                    text: "Should Visit!"
                })
                )
                .append(
                $('<option>', {
                    value: 3,
                    text: "Must Visit!!!"
                })
                ).prop('required', true);
            var $likeLabel = $('<label for="visit-for">Time to Spend</label>')
            var $visitForInput = $('<input>', { type: 'number', name: 'visit-for', value: '30' })
                .addClass('align-self-start rounded mx-1')
                .prop('required', true);
            $priorityLikeInputs.append($priorityLabel).append($prioritySelectorInput);
            $priorityLikeInputs.append($likeLabel).append($visitForInput);
            $optionsDiv.append($priorityLikeInputs);
            var openingTimes = getPlaceOpeningTimes(googlePlaceMarker.placeResult);
            googlePlaceMarker.openingTimes = openingTimes;
            var $li = $('<li>').addClass('list-group-item d-flex');
            //$li.append($imgDiv);
            $li.append($optionsDiv);
            $li.append($secondOptionsDiv);
            //$li.append($name);
            // creating the input to Start in this location (i.e. hotel)
            //var $startHere = $('<input>', {type:'checkbox', name:'startHere'}).prop('checked',beChecked);
            //$startHere.appendTo($li);
            // inserting click event to display on map
            // var marker = new google.maps.Marker({
            //     position: { 
            //         lat: googlePlace.geometry.location.lat(), 
            //         lng: googlePlace.geometry.location.lng() 
            //     }
            // });
            // marker.placeResult = googlePlace;
            // google.maps.event.addListener(marker, "click", showInfoWindow);
            // setTimeout(dropMarker(marker))
            $li.on("click", function () {
                google.maps.event.trigger(googlePlaceMarker, 'click');
            });
            $li.appendTo($ul);
            $searchedPlaces.append($ul);
            */

        }

        // Get the place details for a hotel. Show the information in an info window,
        // anchored on the marker for the hotel that the user selected.
        function showInfoWindow() {
            var marker = this;
            placesService.getDetails({ placeId: marker.placeResult.place_id },
                function (place, status) {
                    if (status !== google.maps.places.PlacesServiceStatus.OK) {
                        return;
                    }
                    infoWindow.open(map, marker);
                    buildIWContent(place);
                });
        }

        // Load the place information into the HTML elements used by the info window.
        function buildIWContent(place) {
            document.getElementById("iw-icon").innerHTML =
                '<img class="placeIcon" ' + 'src="' + place.icon + '"/>';
            document.getElementById("iw-url").innerHTML =
                '<b><a href="' + place.url + '">' + place.name + "</a></b>";
            document.getElementById("iw-address").textContent = place.vicinity;

            if (place.formatted_phone_number) {
                document.getElementById("iw-phone-row").style.display = "";
                document.getElementById("iw-phone").textContent =
                    place.formatted_phone_number;
            } else {
                document.getElementById("iw-phone-row").style.display = "none";
            }

            // Assign a five-star rating to the hotel, using a black star ('&#10029;')
            // to indicate the rating the hotel has earned, and a white star ('&#10025;')
            // for the rating points not achieved.
            if (place.rating) {
                var ratingHtml = "";
                for (var i = 0; i < 5; i++) {
                    if (place.rating < i + 0.5) {
                        ratingHtml += "&#10025;";
                    } else {
                        ratingHtml += "&#10029;";
                    }
                    document.getElementById("iw-rating-row").style.display = "";
                    document.getElementById("iw-rating").innerHTML = ratingHtml;
                }
            } else {
                document.getElementById("iw-rating-row").style.display = "none";
            }

            // The regexp isolates the first part of the URL (domain plus subdomain)
            // to give a short URL for displaying in the info window.
            if (place.website) {
                var fullUrl = place.website;
                var website = hostnameRegexp.exec(place.website);
                if (website === null) {
                    website = "http://" + place.website + "/";
                    fullUrl = website;
                }
                document.getElementById("iw-website-row").style.display = "";
                document.getElementById("iw-website").textContent = website;
            } else {
                document.getElementById("iw-website-row").style.display = "none";
            }
        }

        function populateMarkers(place) {
            //Each found place need an icon.
            var icon = {
                url: place.icon,
                size: new google.maps.Size(80, 80),
                origin: new google.maps.Point(0, 0),
                anchor: new google.maps.Point(17, 34),
                scaledSize: new google.maps.Size(25, 25)
            };
            // Create marker from place
            var googlePlaceMarker = new google.maps.Marker({
                map: map,
                icon: icon,
                title: place.name,
                position: place.geometry.location,
                animation: google.maps.Animation.DROP,
            });
            // Fill the marker with the Google Place Result
            googlePlaceMarker.placeResult = place;
            // Add the listener to the map on click.
            google.maps.event.addListener(googlePlaceMarker, "click", showInfoWindow);
            // Push the entire marker to the markers dict.
            markers.push(googlePlaceMarker);
            addSelectedPlaceToSidebar(googlePlaceMarker);
        }

        // Helper function to remove all the markers from the map.
        function clearOldMarkers() {
            // Clear out the old markers.
            markers.forEach(function (marker) {
                marker.setMap(null);
            });
            markers = [];
            placesSelected = [];
            placesWithNames = {};
            googleSearchedPlaces = [];
            idOfPlacesSelected = [];
            $('#id_placesToVisit').val('');
            $('#id_distanceMx').val('');
            $('#searchedPlaces ul').remove();
            $('#pac-input').val(" ");
            $('#pac-input').focus();
            // delete also old directions renderers:
            // clear old renderers.
            directionsRendererList.forEach(function(directionRenderer){
                directionRenderer.setMap(null);
                directionRenderer = null;
            });



        }

        function clearThisMarker(placeId){
            var indexToRemove = null;
            markers.forEach( function(marker, index) {
                if (marker.placeResult.place_id === placeId){
                    indexToRemove = index;
                }
            });
            delete placesWithNames[placeId];
            google.maps.event.clearInstanceListeners(markers[indexToRemove]);
            markers[indexToRemove].setMap(null);
            // Remove the marker from Markers List
            markers.splice(indexToRemove, 1);
            // Remove place from SidebarList.
            $liToDelete = $('#searchedPlaces ul').find("[data-place_id='"+placeId+"']");
            $liToDelete.remove();
            // Remove place from PlacesSelected List
            var indexToRemovePlaces = null;
            placesSelected.forEach( function(place, index){
                if (place.place_id === placeId){
                    indexToRemovePlaces = index;
                }
            });
            var indexToRemoveIds = null;
            idOfPlacesSelected.forEach( function(place, index){
                if (place === placeId){
                    indexToRemoveIds = index;
                }
            });

            placesSelected.splice(indexToRemovePlaces,1);
            idOfPlacesSelected.splice(indexToRemoveIds,1);

        }

        // Code to prevent user of pressing enter on input to avoid massive searches.
        $('.noEnterSubmit').keypress(function (e) {
            if (e.which === 13) e.preventDefault();
        });
    </script>
</body>

</html>